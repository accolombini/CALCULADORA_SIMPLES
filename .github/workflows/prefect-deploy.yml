# Destaques e justificativas
# ExplicaÃ§Ã£o:
# on push -> Orquestra somente quando houver modificaÃ§Ãµes no repositÃ³rio â€” evitando execuÃ§Ãµes inÃºteis
# curl -I -> Testa a conexÃ£o com o Prefect Cloud antes de continuar
# --no-deps + pip install -> Garante instalaÃ§Ã£o limpa e rÃ¡pida das versÃµes fixas
# prefect deploy -n hello-deploy -> Reflete exatamente o que estÃ¡ no prefect.yaml, alinhado com a lÃ³gica flow_versao1.py
# Retry com for i in {1..5} -> EstratÃ©gia resiliente para evitar falhas intermitentes de rede
# Prefect Cloud
# O Prefect Cloud Ã© uma plataforma de orquestraÃ§Ã£o de fluxos de trabalho que permite monitorar, agendar e gerenciar fluxos de dados em tempo real.
# Ele oferece uma interface de usuÃ¡rio intuitiva, integraÃ§Ã£o com ferramentas populares e suporte para fluxos de trabalho complexos.
# O Prefect Cloud Ã© uma soluÃ§Ã£o ideal para equipes que desejam simplificar a orquestraÃ§Ã£o de fluxos de trabalho e melhorar a eficiÃªncia operacional.
# paths: restringe a execuÃ§Ã£o somente se arquivos importantes forem modificados (evita execuÃ§Ãµes desnecessÃ¡rias).
# O comando prefect deploy usa diretamente o prefect.yaml do projeto.
# Secrets jÃ¡ foram definidos corretamente como vimos na imagem anterior.
# O deploy ocorre apenas em pushs no main, o que Ã© ideal.

name: Deploy Prefect Flow

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ Instalar Python 3.12.5
        uses: actions/setup-python@v4
        with:
          python-version: "3.12.5"

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install -U pip
          pip install -r requirements.txt
          pip install prefect==2.16.4

      - name: ğŸ§ª Executar Testes UnitÃ¡rios
        run: |
          python -m unittest discover -s tests -p "*.py"

      - name: ğŸŒ Verificar conexÃ£o com Prefect Cloud
        run: |
          curl -I https://api.prefect.cloud

      - name: ğŸ” Autenticar no Prefect Cloud
        env:
          PREFECT_API_KEY: ${{ secrets.PREFECT_API_KEY }}
          PREFECT_API_URL: ${{ secrets.PREFECT_API_URL }}
        run: |
          prefect cloud login --key $PREFECT_API_KEY --workspace uff-eletrica/default

      - name: ğŸš€ Deploy do Flow com retry
        run: |
          for i in {1..5}; do
            prefect deploy -n hello-deploy && break || sleep 5
          done
